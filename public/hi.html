<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Items</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-y: auto;
        }

        .container {
            width: 100vw;
            height: 100vh;
            padding: 0;
            margin: 0;
            max-width: none;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .menu-container {
            width: 100vw;
            /* Full width now that right container is gone/empty */
            height: auto;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            /* Center content */
        }

        .right-container {
            display: none;
            /* Hide right container */
        }

        .pay-btn-container {
            width: 100%;
            max-width: 800px;
            /* Match table width to align perfectly */
            margin-top: 1.5rem;
            /* Slightly reduced margin for tighter grouping */
        }

        .table-container {
            width: 100%;
            max-width: 800px;
            /* Limit table width */
        }



        .header {
            margin-bottom: 2rem;
            text-align: left;
        }

        .table-container {
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: white;
            font-size: 1.1rem;
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: middle;
        }

        /* Checkbox column width - now last child */
        th:last-child,
        td:last-child {
            width: 50px;
            text-align: center;
        }

        th {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
            cursor: pointer;
        }

        .total-row td {
            font-weight: 700;
            font-size: 1.2rem;
            color: #fff;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .glass-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            padding: 1rem 2rem;
            box-sizing: border-box;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-container {
            margin-top: 80px;
            /* Space for fixed nav */
            display: flex;
            flex-direction: column;
            /* Changed to column to stack properly if needed, primarily centered now */
            width: 100vw;
            min-height: calc(100vh - 80px);
            align-items: center;
            /* Center everything */
            justify-content: flex-start;
            /* Enable scrolling on desktop */
        }

        /* Animation Keyframes */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .menu-container tr {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        .menu-container tr:nth-child(1) {
            animation-delay: 0.1s;
        }

        .menu-container tr:nth-child(2) {
            animation-delay: 0.2s;
        }

        .menu-container tr:nth-child(3) {
            animation-delay: 0.3s;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                background: linear-gradient(135deg, #1a1a1a, #2c3e50);
            }

            .main-container {
                flex-direction: column;
                height: auto;
                margin-top: 150px;
                /* Increased space for stacked nav */
                padding-bottom: 40px;
                width: 100%;
                overflow-x: hidden;
                /* Prevent horizontal scroll */
            }

            .menu-container {
                width: 100vw;
                padding: 0;
                /* Remove padding to let grid control with its own padding */
                background: transparent;
                /* Remove glass bg on container to avoid double border look if tight */
                border: none;
                box-shadow: none;
            }

            .nav-content {
                flex-direction: column;
                contain: content;
            }

            .nav-header {
                justify-content: space-between;
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .hamburger-btn {
                display: block;
            }

            .nav-links {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
                display: none;
                /* Ensure hidden by default */
                animation: slideDown 0.3s ease-out;
            }

            .nav-links.active {
                display: flex;
            }

            /* Removed conflicting .nav-content>div rule */

            .logo {
                margin-bottom: 0;
                /* Reset margin */
                font-size: 1.4rem;
            }

            .nav-btn,
            .logout-btn {
                width: 100%;
                justify-content: center;
                padding: 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <nav class="glass-nav">
        <div class="nav-content">
            <div class="nav-header">
                <span class="logo">ðŸŽ‰ FestOrders</span>
                <button class="hamburger-btn" id="mobile-menu-btn" onclick="toggleMenu()">
                    <i class="bi bi-list"></i>
                    <span id="hamburger-badge" class="hamburger-badge"></span>
                </button>
            </div>
            <div class="nav-links" id="nav-links">
                <button id="my-cart-btn" class="nav-btn">
                    <i class="bi bi-cart-fill"></i> Cart <span id="cart-count"
                        style="background: #ef4444; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem; display: none; margin-left: 5px;">0</span>
                </button>
                <button id="my-orders-btn" class="logout-btn"
                    style="background: rgba(99, 102, 241, 0.2); border-color: rgba(99, 102, 241, 0.4); display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-clock-history"></i> My Orders
                </button>
                <button id="logout-btn" class="logout-btn" title="Logout"
                    style="display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </div>
    </nav>
    <style>
        /* Hamburger Menu Styles */
        .nav-header {
            display: flex;
            align-items: center;
            /* gap: 1rem; */
            /* No gap needed if space-between usage, but here logo is separate */
        }

        .hamburger-btn {
            display: none;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }

        .hamburger-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: none;
            /* Hidden by default */
            z-index: 10;
            pointer-events: none;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                align-items: stretch;
                /* Change to stretch to fill width */
            }

            .nav-header {
                justify-content: space-between;
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .hamburger-btn {
                display: block;
            }

            .nav-links {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
                display: none;
                /* Hidden by default */
                animation: slideDown 0.3s ease-out;
            }

            .nav-links.active {
                display: flex;
                background: rgba(30, 41, 59, 0.95);
                padding: 1rem;
                padding-top: 2rem;
                /* Extra space for close flow */
                border-radius: 0 0 12px 12px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
            }

            .nav-links>button {
                width: 100%;
                justify-content: center;
                padding: 12px;
                margin-bottom: 8px;
                /* Spacing between buttons */
                color: #1e293b !important;
                /* Dark text for light buttons */
                font-weight: 600;
                border: none !important;
                /* Remove borders */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

            /* Specific Light Colors for Buttons */
            #my-cart-btn {
                background: #fecaca !important;
                /* Light Red */
            }

            #my-orders-btn {
                background: #c7d2fe !important;
                /* Light Indigo */
            }

            #logout-btn {
                background: #e2e8f0 !important;
                /* Light Slate */
            }

            /* Ensure badge text is white on light red? Or dark? */
            #cart-count {
                background: #dc2626 !important;
                /* Darker red for contrast */
                color: white;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }

        /* Hamburger Animation & Blur */
        .hamburger-btn i {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .hamburger-btn.active i {
            transform: rotate(90deg);
        }

        .main-container {
            transition: filter 0.3s ease;
        }

        .main-container.blur-active {
            filter: blur(5px);
            pointer-events: none;
            /* Prevent clicks while menu is open */
        }

        /* Flying Image Animation */
        .flying-img {
            position: fixed;
            z-index: 3000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            pointer-events: none;
            transition: all 0.8s ease-in-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            opacity: 0.9;
        }
    </style>

    <div class="main-container">
        <div class="glass-card menu-container">
            <div class="header">
                <h1>Delicious Items</h1>
                <p>Select your favorites</p>
            </div>

            <div class="menu-grid" id="items-grid">
                <!-- Loader -->
                <div class="loader-container">
                    <div class="loader"></div>
                    <div class="loader-text">Loading delicious items...</div>
                </div>
            </div>

            <!-- Copyright Footer -->
            <!-- Copyright Footer -->
            <div
                style="text-align: center; padding: 2rem 0 4rem 0; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: center;">
                <div>&copy; 2027 Bhargav. All rights reserved.</div>
                <div>
                    Contact: <a href="mailto:bhargavbala56@gmail.com"
                        style="color: #6366f1; text-decoration: none; border-bottom: 1px dashed rgba(99, 102, 241, 0.4);">bhargavbala56@gmail.com</a>
                </div>
            </div>

            <!-- Pay Button Container Removed - Moved to Cart Modal -->
        </div>
    </div>
    </div>

    <!-- My Cart Modal -->
    <div class="modal-overlay" id="cart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Your Cart</h2>
                <button class="close-modal" id="close-cart-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cart-items-list">
                    <!-- Cart Items injected here -->
                </div>

                <div class="cart-total-section">
                    <span>Total Amount</span>
                    <span id="cart-total-display">â‚¹0</span>
                </div>

                <button id="checkout-btn" class="btn-checkout">Confirm & Pay</button>
            </div>
        </div>
    </div>

    <!-- My Orders Modal -->
    <div class="modal-overlay" id="orders-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">My Orders</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="orders-list">
                <!-- Orders will be loaded here -->
                <div style="text-align: center; color: #94a3b8; padding: 2rem;">Loading orders...</div>
            </div>
        </div>
    </div>



    <!-- QR Code Modal (Order Ticket) -->
    <div class="modal-overlay" id="qr-modal" style="z-index: 2001;">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <div class="modal-header">
                <h2 class="modal-title">Order Ticket</h2>
                <button class="close-modal" id="close-qr-modal">&times;</button>
            </div>
            <div class="modal-body"
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;">
                <div id="qrcode" style="background: white; padding: 10px; border-radius: 8px;"></div>
                <p style="margin-top: 1rem; color: #cbd5e1; font-size: 0.9rem;">Scan this code at the counter</p>
                <div id="qr-order-id" style="font-weight: bold; margin-top: 0.5rem; color: #6366f1;"></div>
            </div>
        </div>
    </div>

    <script>
        const itemsGrid = document.getElementById('items-grid');
        const payBtn = document.getElementById('pay-btn');

        let cart = {}; // { ItemName: { price: 100, qty: 1 } }
        let allItems = []; // Store fetched items

        // Initialize Cart from LocalStorage
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
            try {
                cart = JSON.parse(savedCart);
            } catch (e) {
                console.error("Failed to parse saved cart", e);
                cart = {};
            }
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        // Fetch Items
        async function loadItems() {
            try {
                const res = await fetch('/api/items');
                const items = await res.json();
                allItems = items;

                if (items.length === 0) {
                    itemsGrid.innerHTML = '<div style="text-align:center; color: white; width: 100%; grid-column: 1/-1;">No items available.</div>';
                    return;
                }

                itemsGrid.innerHTML = '';
                items.forEach(item => {
                    // Use placeholder if no image
                    const imgUrl = item.image || `https://source.unsplash.com/500x300/?${encodeURIComponent(item.name)},food`;

                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `
                            <img src="${imgUrl}" alt="${item.name}" class="card-image" onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=500&auto=format&fit=crop&q=60'">
                            <div class="card-content">
                                <div class="card-header">
                                    <h3 class="item-title">${item.name}</h3>
                                    <span class="item-price">â‚¹${item.price}</span>
                                </div>
                                <p class="item-desc">${item.description || 'Tasty and fresh!'}</p>
                                
                                <div class="card-actions" id="action-${item.name.replace(/\s+/g, '-')}">
                                    ${getActionHtml(item)}
                                </div>
                            </div>
                        `;
                    itemsGrid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading items:', error);
                itemsGrid.innerHTML = '<div style="text-align:center; color: #ff4444; width: 100%; grid-column: 1/-1;">Error loading menu.</div>';
            }
        }

        const cartModal = document.getElementById('cart-modal');
        const myCartBtn = document.getElementById('my-cart-btn');
        const closeCartBtn = document.getElementById('close-cart-modal');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalDisplay = document.getElementById('cart-total-display');
        const checkoutBtn = document.getElementById('checkout-btn');
        const cartCountBadge = document.getElementById('cart-count');

        // Toggle Cart
        function toggleCart(show) {
            if (show) {
                renderCart();
                cartModal.classList.add('active');
            } else {
                cartModal.classList.remove('active');
            }
        }

        myCartBtn.addEventListener('click', () => toggleCart(true));
        closeCartBtn.addEventListener('click', () => toggleCart(false));
        cartModal.addEventListener('click', (e) => {
            if (e.target === cartModal) toggleCart(false);
        });

        loadItems();

        // Helper to get action HTML based on cart state
        function getActionHtml(item) {
            const inCart = cart[item.name];
            const qty = inCart ? inCart.qty : 0;

            if (qty > 0) {
                return `
                    <div class="qty-control" style="display: flex;">
                        <button class="qty-btn" onclick="updateQty('${item.name}', -1)">-</button>
                        <span class="qty-val" style="color: white; font-weight: bold;">${qty}</span>
                        <button class="qty-btn" onclick="updateQty('${item.name}', 1)">+</button>
                    </div>
                `;
            } else {
                return `<button class="btn-add-cart" onclick="addToCart('${item.name}', ${item.price}, this)">Add to Cart</button>`;
            }
        }

        function updateCardUi(name) {
            const safeName = name.replace(/\s+/g, '-');
            const actionContainer = document.getElementById(`action-${safeName}`);
            if (actionContainer) {
                // Find item details from allItems to rebuild HTML
                const item = allItems.find(i => i.name === name);
                if (item) {
                    actionContainer.innerHTML = getActionHtml(item);
                }
            }
        }

        window.addToCart = function (name, price, btnElement) {
            if (!cart[name]) {
                cart[name] = { price: price, qty: 1 };
            } else {
                cart[name].qty++;
            }

            // Trigger Animation
            if (btnElement) {
                // Try to find image src from the card
                const card = btnElement.closest('.item-card');
                let imgUrl = null;
                if (card) {
                    const img = card.querySelector('.card-image');
                    if (img) imgUrl = img.src;
                }
                animateFlyToCart(btnElement, imgUrl);
            }

            saveCart();
            updateTotal();
            updateCardUi(name);
        }

        function animateFlyToCart(startBtn, imageUrl) {
            if (!startBtn) return;

            const cartBtn = document.getElementById('my-cart-btn');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');

            // Determine the visible target
            let targetElem = null;

            // Check if mobile menu button is visible
            if (mobileMenuBtn && mobileMenuBtn.offsetParent !== null) {
                targetElem = mobileMenuBtn;
            }
            // Fallback to cart button if visible
            else if (cartBtn && cartBtn.offsetParent !== null) {
                targetElem = cartBtn;
            }

            // If no visible target found, abort animation
            if (!targetElem) return;

            // Create flying image
            const flyer = document.createElement('img');
            flyer.src = imageUrl || 'https://via.placeholder.com/50';
            flyer.classList.add('flying-img');

            // Get positions
            const startRect = startBtn.getBoundingClientRect();
            const endRect = targetElem.getBoundingClientRect();

            // Initial Position (Center of button)
            const startX = startRect.left + startRect.width / 2 - 25; // 25 is half of 50px width
            const startY = startRect.top + startRect.height / 2 - 25;

            // Target Position (Center of target icon)
            const endX = endRect.left + endRect.width / 2 - 25;
            const endY = endRect.top + endRect.height / 2 - 25;

            flyer.style.left = `${startX}px`;
            flyer.style.top = `${startY}px`;

            document.body.appendChild(flyer);

            // Force reflow
            flyer.offsetHeight;

            // Start Animation
            requestAnimationFrame(() => {
                flyer.style.left = `${endX}px`;
                flyer.style.top = `${endY}px`;
                flyer.style.width = '20px'; // Shrink while flying
                flyer.style.height = '20px';
                flyer.style.opacity = '0.5';
            });

            // Cleanup after transition
            setTimeout(() => {
                if (flyer.parentNode) flyer.parentNode.removeChild(flyer);

                // Shake target for feedback
                if (targetElem) {
                    const originalTransform = targetElem.style.transform;
                    targetElem.style.transform = 'scale(1.2)';
                    setTimeout(() => targetElem.style.transform = originalTransform, 200);
                }
            }, 800); // Match CSS transition time
        }

        window.updateQty = function (name, change) {
            if (cart[name]) {
                cart[name].qty += change;
                if (cart[name].qty <= 0) {
                    delete cart[name];
                }
            }
            saveCart();

            // Re-render cart if open
            if (cartModal.classList.contains('active')) {
                renderCart();
            }

            // Always update card UI
            updateCardUi(name);
            updateTotal();
        }

        function renderCart() {
            cartItemsList.innerHTML = '';
            let total = 0;
            const items = Object.entries(cart);

            if (items.length === 0) {
                cartItemsList.innerHTML = '<div style="text-align:center; color: #94a3b8; padding: 2rem;">Your cart is empty.</div>';
                checkoutBtn.style.display = 'none';
            } else {
                checkoutBtn.style.display = 'block';
                items.forEach(([name, details]) => {
                    total += details.price * details.qty;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <div class="cart-item-details">
                            <h4 class="cart-item-title">${name}</h4>
                            <span class="cart-item-price">â‚¹${details.price} x ${details.qty}</span>
                        </div>
                        <div class="cart-item-actions">
                            <div class="qty-control" style="display: flex; background: transparent;">
                                <button class="qty-btn" onclick="updateQty('${name}', -1)">-</button>
                                <span class="qty-val" style="margin: 0 10px;">${details.qty}</span>
                                <button class="qty-btn" onclick="updateQty('${name}', 1)">+</button>
                            </div>
                        </div>
                    `;
                    cartItemsList.appendChild(itemEl);
                });
            }

            cartTotalDisplay.textContent = `â‚¹${total}`;
        }

        const hamburgerBadge = document.getElementById('hamburger-badge');

        function updateTotal() {
            let total = 0;
            let count = 0;
            Object.values(cart).forEach(item => {
                total += item.price * item.qty;
                count += item.qty;
            });

            if (count > 0) {
                cartCountBadge.style.display = 'inline-block';
                cartCountBadge.textContent = count;
                if (hamburgerBadge) hamburgerBadge.style.display = 'block';
            } else {
                cartCountBadge.style.display = 'none';
                if (hamburgerBadge) hamburgerBadge.style.display = 'none';
            }
            return total;
        }

        const paymentModal = document.getElementById('payment-modal');
        const closePaymentBtn = document.getElementById('close-payment-modal');
        const paymentQrContainer = document.getElementById('payment-qr');
        const verifyPaymentBtn = document.getElementById('verify-payment-btn');
        const txnInput = document.getElementById('transaction-id');
        const payNowLink = document.getElementById('pay-now-link');

        // Config variables
        let UPI_ID = "example@upi";
        let MERCHANT_NAME = "FestOrders";

        // Fetch Config
        // Fetch Config
        fetch('/api/config')
            .then(res => res.json())
            .then(config => {
                if (config.upiId) UPI_ID = config.upiId;
                if (config.merchantName) MERCHANT_NAME = config.merchantName;
                document.getElementById('upi-display').value = UPI_ID; // Update Display
                console.log('Payment Config Loaded');
            })
            .catch(err => console.error('Failed to load config', err));

        window.copyUpiId = function () {
            navigator.clipboard.writeText(UPI_ID).then(() => {
                const btn = document.querySelector('button[onclick="copyUpiId()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
                btn.style.background = '#16a34a';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#2563eb';
                }, 2000);
            });
        };

        function openPaymentModal(total) {
            paymentModal.classList.add('active');

            // Construct UPI Deep Link
            // Remove 'pn' and 'tn' to avoid "Risk Policy" blocks (Name mismatch triggers this)
            // Just sending PA (Address) and AM (Amount) is the safest way for personal accounts.
            const upiLink = `upi://pay?pa=${UPI_ID}&am=${total}&cu=INR`;

            // Set Link
            payNowLink.href = upiLink;

            // Generate QR
            paymentQrContainer.innerHTML = "";
            new QRCode(paymentQrContainer, {
                text: upiLink,
                width: 150,
                height: 150
            });
        }









        // Check for Payment Callback Params
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');

            if (status === 'success') {
                const amount = urlParams.get('amount');
                const id = urlParams.get('id');
                // Clear cart if successful
                cart = {};
                saveCart();
                updateTotal();

                // Show Success Modal
                document.body.innerHTML += `
                <div class="modal-overlay active" style="z-index: 3000;">
                    <div class="modal-content" style="text-align: center;">
                        <div style="color: #16a34a; font-size: 3rem; margin-bottom: 1rem;">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <h2>Payment Successful!</h2>
                        <p>Your Order ID: <strong>${id}</strong></p>
                        <p>Amount Paid: â‚¹${amount}</p>
                        <button onclick="window.location.href='/hi.html'" class="btn-primary" style="margin-top: 1rem;">Continue</button>
                    </div>
                </div>`;
            } else if (status === 'failure') {
                const reason = urlParams.get('reason');
                alert('Payment Failed: ' + reason);
            }
        };


        async function generateOrder() {
            const total = updateTotal();
            if (Object.keys(cart).length === 0) {
                alert('Cart is empty!');
                return;
            }

            // Retrieve user details
            const userJson = localStorage.getItem('user');
            let mobileNumber = "-";
            let email = "-";

            if (userJson) {
                try {
                    const user = JSON.parse(userJson);
                    mobileNumber = user.whatsappNumber || "-";
                    email = user.email || "-";
                } catch (e) { console.error(e); }
            }

            const finalItems = [];
            Object.entries(cart).forEach(([name, details]) => {
                finalItems.push({
                    name: `${name} (x${details.qty})`,
                    price: details.price * details.qty
                });
            });

            // Prevent double click
            checkoutBtn.innerHTML = 'Placing Order...';
            checkoutBtn.disabled = true;

            try {
                const res = await fetch('/api/generate-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: finalItems,
                        totalAmount: total,
                        mobileNumber,
                        email,
                        transactionId: "PAY_LATER"
                    })
                });

                const data = await res.json();

                if (res.ok && data.uniqueId) {
                    alert(`Order Placed!\nYour Order ID: ${data.uniqueId}`);
                    // Clear cart
                    cart = {};
                    saveCart();
                    updateTotal();
                    toggleCart(false);
                } else {
                    alert(`Failed: ${data?.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Order Error:', error);
                alert(`Network Error: ${error.message}`);
            } finally {
                checkoutBtn.innerHTML = 'Confirm & Pay';
                checkoutBtn.disabled = false;
            }
        }

        checkoutBtn.addEventListener('click', generateOrder);

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        });

        // My Orders Logic
        const myOrdersBtn = document.getElementById('my-orders-btn');
        const ordersModal = document.getElementById('orders-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const ordersList = document.getElementById('orders-list');

        function toggleModal(show) {
            if (show) {
                ordersModal.classList.add('active');
                fetchMyOrders();
            } else {
                ordersModal.classList.remove('active');
            }
        }

        myOrdersBtn.addEventListener('click', () => toggleModal(true));
        closeModalBtn.addEventListener('click', () => toggleModal(false));

        // Close on outside click
        ordersModal.addEventListener('click', (e) => {
            if (e.target === ordersModal) toggleModal(false);
        });

        async function fetchMyOrders() {
            ordersList.innerHTML = `
                <div class="dots-loader">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;

            // Get user info
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                ordersList.innerHTML = '<div style="text-align: center; color: #f87171; padding: 2rem;">User info not found. Please relogin.</div>';
                return;
            }

            try {
                const user = JSON.parse(userJson);
                const mobileNumber = user.whatsappNumber || "-";
                const email = user.email || "-";

                const res = await fetch('/api/my-orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mobileNumber, email })
                });

                const orders = await res.json();

                if (orders.length === 0) {
                    ordersList.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No previous orders found.</div>';
                    return;
                }

                ordersList.innerHTML = orders.map(order => {
                    const date = new Date(order.createdAt).toLocaleDateString() + ' ' + new Date(order.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const statusClass = order.status === 'used' ? 'status-used' : 'status-unused';

                    const itemsHtml = order.items.map(item =>
                        `<div>${item.name} <span style="opacity: 0.7">x 1</span> <span style="float:right">â‚¹${item.price}</span></div>`
                    ).join('');

                    return `
                        <div class="order-card">
                            <div class="order-header">
                                <span class="order-id">${order.uniqueId}</span>
                                <span class="order-status ${statusClass}">${order.status.toUpperCase()}</span>
                            </div>
                            <div class="order-items">
                                ${itemsHtml}
                            </div>
                            <div class="order-footer">
                                <span>${date}</span>
                                <span style="color: white; font-weight: 600;">Total: â‚¹${order.totalAmount}</span>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.05); text-align: center;">
                                <button onclick="showQRCode('${order.uniqueId}')" style="background: white; color: #000; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px;">
                                    <span>ðŸ“±</span> Show QR Ticket
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersList.innerHTML = '<div style="text-align: center; color: #f87171; padding: 2rem;">Failed to load orders.</div>';
            }
        }


        // QR Code Logic
        const qrModal = document.getElementById('qr-modal');
        const closeQrBtn = document.getElementById('close-qr-modal');
        const qrcodeContainer = document.getElementById('qrcode');
        const qrOrderId = document.getElementById('qr-order-id');

        window.showQRCode = function (uniqueId) {
            qrModal.classList.add('active');
            qrOrderId.textContent = uniqueId;
            qrcodeContainer.innerHTML = ''; // Clear previous

            new QRCode(qrcodeContainer, {
                text: uniqueId,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        };

        function closeQRCode() {
            qrModal.classList.remove('active');
        }

        closeQrBtn.addEventListener('click', closeQRCode);

        qrModal.addEventListener('click', (e) => {
            if (e.target === qrModal) closeQRCode();
        });

        // Hamburger Menu Logic
        function toggleMenu() {
            const navLinks = document.getElementById('nav-links');
            const hamburgerBtn = document.querySelector('.hamburger-btn');
            const mainContainer = document.querySelector('.main-container');
            const icon = hamburgerBtn.querySelector('i');

            navLinks.classList.toggle('active');
            hamburgerBtn.classList.toggle('active');

            if (navLinks.classList.contains('active')) {
                // Menu Opened
                icon.classList.remove('bi-list');
                icon.classList.add('bi-x-lg');
                mainContainer.classList.add('blur-active');
            } else {
                // Menu Closed
                icon.classList.remove('bi-x-lg');
                icon.classList.add('bi-list');
                mainContainer.classList.remove('blur-active');
            }
        }

        // Initialize total on load
        updateTotal();

    </script>

</html>